name: CI
on:
  push:
    branches-ignore:
    - _**
  pull_request:
  merge_group:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Set-up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5
      - uses: actions/checkout@master
        with:
          submodules: true
          path: everparse
      - name: Everparse CI
        run: |
          make -C everparse -j$(nproc) -k ci branchname=${{ github.head_ref || github.ref_name }}
        env:
          DZOMO_GITHUB_TOKEN: ${{ secrets.DZOMO_GITHUB_TOKEN }}

      # I'm leaving this disabled as I do not get good incrementality
      # when trying this out by hand due to dependence hash mismatches
      # everywhere.
      - name: Incrementality test
        if: false
        working-directory: everparse/tests/sample
        run: |
            echo 'let foo : FStar.UInt32.t = 42ul' >> Data.fsti
            echo 'let foo : FStar.UInt32.t = Data.foo' >> Test.fst
            make -j$(nproc)
            git checkout Test.fst
            sed -i 's!payloads!payload!g' Test.rfc
            make -j$(nproc)
            git checkout Test.rfc

  # Branch protection points here.
  ciok:
    runs-on: ubuntu-latest
    needs: ci
    if: ${{ cancelled() || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure') }}
    steps:
      # Note: we only run on failure. Otherwise this is skipped, which counts
      # as a success.
      - run: exit 1
